<%= render 'filters' %>

<% @node_filters = session[:filters] %>
<% if @node.parent != nil %>
  <ol class="breadcrumb">
    <% if @node.parent.parent != nil %>
      <li><%= link_to Node.find(@node.parent.parent).name , @node.parent.parent %> </li>
    <% end %>
    <li> <%= link_to Node.find(@node.parent).name , @node.parent %></li>

  </ol>
<% end %>

<div class="page-header" style="margin-top:0px;">
  <h2><%= @node.name %> <small>[<%= @node.nodeType.name %> - <%= @node.progress_status %>]</small></h2>

<%= link_to 'Edit', edit_node_path(@node) %>
<% if !@node.nodeType.specification %>
  <%= link_to 'View Feature Inventory', feature_inventory_path(@node) %>
  <%= link_to 'Groom Backlog', backlog_path(@node) %>
<% end %>
</div>

<%= simple_format(@node.description) %>

<div>
  <% if !@node.nodeType.specification %>  
  <!-- Comprised of Sub Non-Spec Nodes-->
  <div class="col-md-6">
    <% @root_node_filtered_children = @node.filtered_children(@node_filters) %>
    <% if @root_node_filtered_children.count > 0 %>
      <% @root_node_filtered_children.each do |child| %>
        <div class="panel panel-default">
            <div class="panel-heading ">
            <h3 class="panel-title">
              <% if child.status %> &#x2713; <% else %> &nbsp;&nbsp;&nbsp; <% end %> 
                <%= link_to ("[" + child.nodeType.name + "] " + child.name + " " + child.statusInParens ) , child %> ( <%= child.percent_done(@node_filters) %>% Done)
              </h3>

          </div>
          <% if child.children.count >0 %>
          <div class="panel-body">
              <ul class="list-group">
                <% child.filtered_children(@node_filters).each do |grandkid| %>
                <% if grandkid.status %>
                  <li class="list-group-item list-group-item-success">
                <% else %>
                  <li class="list-group-item">
                <% end %>
                      <% if grandkid.status %> &#x2713; <% else %> &nbsp;&nbsp;&nbsp; <% end %> 
                <%= link_to ("[" + grandkid.nodeType.name + "] " + grandkid.name + " " + grandkid.statusInParens ) , grandkid %>


                <div class="progress">
                  <% grandkid_perecent_done = grandkid.percent_done(@node_filters) %>
                  <% if grandkid_perecent_done != 0 %>
                  <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow=<%= grandkid_perecent_done %> aria-valuemin="0" aria-valuemax="100" style="width: <%= grandkid_perecent_done %>%;">
                    <%= grandkid_perecent_done %>%
                  </div>
                <% end %>
                <% grandkid_perecent_in_progress = grandkid.percent_in_progress(@node_filters) %>
                <% if grandkid_perecent_in_progress != 0 %>
                  <div class="progress-bar progress-bar-warning" role="progressbar" style="width:<%= grandkid_perecent_in_progress %>%;">
                    <%= grandkid_perecent_in_progress %>%
                </div>
              <% end %>
              </div>



                    </li>
                <% end %>
              </ul>
          </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  <% end %> 
  <% if !@node.nodeType.specification %>
    <%= link_to 'Add Node' , new_node_path(@node) %> 
  <% end %>
  </div>
  <div class="col-md-6">
  </div>
</div>


  <br/><br/><br/>
<div>
  <strong>Percent Done:</strong> Toggle between Summary and Breakdown by Phase
                <div class="progress">
                  <% @node_perecent_done = @node.percent_done(@node_filters) %>
                  <% if @node_perecent_done != 0 %>
                  <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow=<%= @node_perecent_done %> aria-valuemin="0" aria-valuemax="100" style="width: <%= @node_perecent_done %>%;">
                    <%= @node_perecent_done %>%
                  </div>
                <% end %>
                <% @node_percent_in_progress = @node.percent_in_progress(@node_filters) %>
                <% if @node_percent_in_progress != 0 %>
                  <div class="progress-bar progress-bar-warning" role="progressbar" style="width:<%= @node_percent_in_progress %>%;">
                    <%= @node_percent_in_progress %>%
                </div>
              <% end %>
              </div>

 <strong>Delivery Dates:</strong>
 <ul>
  <% @delivery_dates.each do |date| %>
    <li><%= date.delivery_type %> <%= date.environment.name %> with <%= date.milestone.name %> <%= link_to 'edit', edit_delivery_date_path(date) %> </li>
  <% end %>
 </ul>
<% if @node.nodeType.specification %>
 <%= link_to 'Add Delivery Date', new_delivery_date_path(@node) %>
 <% end %>
 <br/>

<strong>Phases:</strong> <%= link_to 'Add' , new_phase_path(@node) %> <br/> 
<% if @nodePhases.count > 0 %>
  <% @nodePhases.each do |phase| %>
    <div class="panel panel-default col-md-3">
      <div class="panel-heading">
        <h3 class="panel-title">
          <% if phase.status %>
            <%= phase.type %> <%= link_to 'Done', "", style: "text-decoration: line-through;", id: ("phase-done" + phase.id.to_s) %>
          <% else %>
            <%= phase.type %> <%= link_to 'Mark as Done', "", id: ("phase-mark-done" + phase.id.to_s)  %>
          <% end %>
        </h3>
        <div class="btn-group">
        <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= phase.get_progress_status_text %> <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a href="#">Set to In Progress</a></li>
          <li><a href="#">Set to Done</a></li>
          <li><a href="#">Move Back to Backlog</a></li>
        </ul>
      </div>
         <%= link_to 'temp change', edit_phase_path(phase) %>
      </div>
      <!--
      <div class="panel-body">
      </div>
    -->

  <!-- List group -->
  <ul class="list-group">
    <% @tasks = Task.where(:phase_id => phase) %>

    <lh><h5>Tasks</h5> </li>
          <% if @tasks.count > 0 %>
      <% @tasks.each do |task| %>
                <li class="list-group-item">
                  <%= link_to task.name, task %>
                </li>
               <% end %>
            <% end %>
            <%= link_to 'Add Task' , new_task_path(phase) %>
  </ul>

    <!-- List group -->
  <ul class="list-group">
   <% @dependencies = Dependable.where(:dependentPhase_id => phase.id) %>
  <% if @dependencies.count>0 %>
    <lh><h5>Depends On</h5>
  <% end %>
      <%= link_to "Add Dependency" , new_dependable_path(:phase_id => phase) %>

      <% @dependencies.each do |dependency| %>
        <li class="list-group-item"><%= link_to dependency.name, dependency.phase.node %> </li>
      <% end %>
  </ul>

  <% @dependencies = Dependable.where(:phase_id => phase.id) %>
  <% if @dependencies.count>0 %>
  <ul class="list-group">
    <lh><h5>Depency For</h5>
        
        <% @dependencies.each do |dependency| %>
          <li class="list-group-item"><%= link_to dependency.forPhase.name, dependency.forPhase.node %> </li>
        <% end %>
  </ul>
  <% end %>


</div>  
        <% end %>

      <br/>
             
    
  </tr>


<% end %>    
</div>
<div>

<strong>Has Questions:</strong> <%= link_to 'Add' , new_question_path(@node) %> <br/>
<% if @nodeQuestions.count > 0 %>
  <ul>
    <% @nodeQuestions.each do |question| %>
      <li>
        <%= question.question %>
      </li>
    <% end %>
  </ul>
<% end %> 
<strong>Related Nodes:</strong><br/><br/>
<br/>
<strong>Has Issues:</strong><br/>
<% if @issues.count > 0 %>
  <ul>
    <% @issues.each do |issue| %>
      <li>
        <% if issue.class.name != "NativeIssue" %>
          <% @gitHubRepo = GitHubRepo.where(:id => issue.repo_id).first.repo %>
          <%= link_to image_tag('https://assets-cdn.github.com/favicon.ico', :width => "17px" ) , 'https://github.com/dylanpavelko/'+@gitHubRepo+'/issues/' + issue.number.to_s , target: "_blank"%>
          <%= link_to issue.title , issue %>
        <% else %>
        <%= link_to issue.summary, issue %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %> 
<%= link_to 'Open New Issue', new_native_issue_path(@node) %><br/>
<strong>Subordinate Issues:</strong><br/>
<% if @subIssues.count > 0 %>
  <ul>
    <% @subIssues.each do |issue| %>
      <li>
        <% if issue.class.name == "GitHubIssue" %>
          <%= link_to issue.node.name , issue.node %> > <%= link_to issue.title , issue %>
        <% else %>
          <%= link_to issue.issue_with.name, issue.issue_with %> > <%= link_to issue.summary, issue %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %> 
<% if @issue_resolutions.count > 0 %>
  <strong>Resolves Issues</strong>
  <ul>
  <% @issue_resolutions.each do |issue| %>
        <li>
          <% if issue.class.name == "GitHubIssue" %>
            <%= link_to issue.title , issue %>
          <% else %>
            <%= link_to issue.summary, issue %>
         <% end %>
       </li>
  <% end %>
  <ul>
<% end %>

</div>
<script type="text/javascript">
$('a[id*="phase-done"]').click(function(){
    var phase_id = $(this).attr('id').split("done")[1];
    $.ajax({url: "/phase/set_status", type: "POST", data: {'id': phase_id ,'phase_status': false}, dataType: 'json'});
});

$('a[id*="phase-mark-done"]').click(function(){
    var phase_id = $(this).attr('id').split("done")[1];
    $.ajax({url: "/phase/set_status", type: "POST", data: {'id': phase_id ,'phase_status': true}, dataType: 'json'});
});


</script>

